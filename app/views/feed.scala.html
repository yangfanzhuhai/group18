@(groupID: String, toggle: Integer, userName: String)
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap core CSS -->
    <link href="@routes.Assets.at("stylesheets/bootstrap.min.css")" rel="stylesheet">
      
    <!-- Our own style -->
    <link href ="@routes.Assets.at("stylesheets/theme.css")" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.ico")">

    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.js" type="text/javascript"></script>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="@routes.Application.feed(groupID,0)">Progress</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav" role="navigation">
          <li id="newsfeed_nav" class = "active">
            <a href="@routes.Application.feed(groupID,0)">News Feed</a>
          </li>
          <!--<li id="tasklist_nav"><a href="@routes.Application.feed(groupID,1)">Task List</a></li>-->
          
          <li id="tasklist_nav" class="dropdown">
            <a href="@routes.Application.feed(groupID,1)" class="dropdown-toggle" data-toggle="dropdown">
              Task List 
              <b class="caret"></b></a>
            <ul class="dropdown-menu">
              <li><a href="@routes.Application.feed(groupID,1)">All Tasks</a></li>
          	  <li onclick = "setTaskStatus(this.id)" id = "TO_DO"><a href="#">TO DO</a></li>
          	  <li onclick = "setTaskStatus(this.id)" id = "DOING"><a href="#">DOING</a></li>
          	  <li onclick = "setTaskStatus(this.id)" id = "DONE"><a href="#">DONE</a></li>
        	</ul>
      	  </li>
          
          <li id="git_nav"><a href="@routes.Application.feed(groupID,2)">Git Commits</a></li>
          <li id = "builds_nav"><a href="@routes.Application.feed(groupID,3)">Builds</a></li>
          <li><a href="@routes.Application.about">About</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right" role="navigation">
          <li><a href="@routes.Application.profile">@userName</a></li>
          <li><a href="@routes.Application.login">Log Out</a></li>
        </ul>
      </div> <!--/.nav-collapse -->
    </div>
    </div>

  <div class="container col-md-offset-2 col-md-8">
    <a href="@routes.Application.feed(groupID,0)">
      <img src="@routes.Assets.at("images/title.jpg")" id ="title" alt="some_text"
    	width="200" >
      <img src="@routes.Assets.at("images/logo.jpg")" id = "logo"  alt="some_text"
      width="200" >

    </a>

    <div id = "post_options" align="center">
    		
      <form name="myform" role="form">
        <textarea name="limitedtextarea" type="text" id = "limitedtextfield" rows ="5" cols = "30"
        onKeyDown="postFormOnKeyDown(this)" maxlength="140" class="form-control" 
        placeholder="what's on your mind?" style = "resize: none"> </textarea>
        <br>
        <small align="right"> <!--(Maximum characters: 140)-->
        You have <input readonly type="text" id="charCountdown" name="countdown" size="3" value="140"> characters left.</small>

      </form>

   
    <div class="container col-md-offset-2 col-md-4">
    <select id="post_type" onchange="postTypeChange(this.value)" align = "center" style = "width: 50%" class="form-inline form-control">
      <option value="text_post">Text Post</option>
      <option value="task">Task</option>
    </select>
  </div>
     		
    	<button type="button" class="btn btn-success" onclick="postToFeed()">Post</button>
    </div>
    <h4 id = "task_status"></h4>

    <div id = "posts" class = "float">
    </div>

    <div id="preloader"><img src="@routes.Assets.at("images/482.GIF")" alt=
        "AJAX loader" title="AJAX loader" align="center" /></div>

    <ul id = "stream" class = "media-list" ></ul>
    <div align="center">
      <button class = "btn btn-info" onclick = "loadMoreFeed()">Load More feed</button>
    </div>
  </div> <!-- /container -->  


  <script>
  $.fn.outerHTML = function(){

	    // IE, Chrome & Safari will comply with the non-standard outerHTML, all others (FF) will have a fall-back for cloning
	    return (!this.length) ? this : (this[0].outerHTML || (
	      function(el){
	          var div = document.createElement('div');
	          div.appendChild(el.cloneNode(true));
	          var contents = div.innerHTML;
	          div = null;
	          return contents;
	    })(this[0]));

	}

  
    if (@toggle == 0) {
      document.title = "News Feed";
      document.getElementById("newsfeed_nav").setAttribute("class","active");
      document.getElementById("tasklist_nav").setAttribute("class","");
      document.getElementById("git_nav").setAttribute("class","");
      document.getElementById("builds_nav").setAttribute("class","");
    } else if(@toggle == 1) {
    	document.title = "Task List"
      document.getElementById("newsfeed_nav").setAttribute("class","");
      document.getElementById("tasklist_nav").setAttribute("class","active");
      document.getElementById("git_nav").setAttribute("class","");
      document.getElementById("builds_nav").setAttribute("class","");
    } else if(@toggle == 2) {
      document.title = "Git Commits"
      document.getElementById("git_nav").setAttribute("class","active");
      document.getElementById("newsfeed_nav").setAttribute("class","");
      document.getElementById("tasklist_nav").setAttribute("class","");
      document.getElementById("builds_nav").setAttribute("class","");
    } else if(@toggle == 3) {
      document.title = "Jenkins Builds"
      document.getElementById("builds_nav").setAttribute("class","active");
      document.getElementById("newsfeed_nav").setAttribute("class","");
      document.getElementById("tasklist_nav").setAttribute("class","");
      document.getElementById("git_nav").setAttribute("class","");
    }

    function postFormOnKeyDown (currentElement) {
      if (event.keyCode == 13) { 
        postToFeed(); 
        return false; 
      }
      var dropdown = document.getElementById("post_type");
      if (dropdown.options[dropdown.selectedIndex].value == "task") {
        limitText(currentElement.form.limitedtextfield, currentElement.form.countdown,20);
      } else {
        limitText(currentElement.form.limitedtextfield, currentElement.form.countdown,140);
      }
    }

    function limitText(limitField, limitCount, limitNum) {
      if (limitField.value.length > limitNum) {
        limitField.value = limitField.value.substring(0, limitNum);
      } else {
        limitCount.value = limitNum - limitField.value.length;
      }
    }

  var post_count = 0;
  var task_ids = [];
  var tasks = [];
  var task_names = [];
  var final_post_id;

  document.getElementById("title").style.marginTop = "20px";
  document.getElementById("title").style.marginBottom = "10px";
  document.getElementById("logo").style.float = "right";
  document.getElementById("logo").style.marginTop = "25px";
  document.getElementById("charCountdown").style.marginBottom = "10px";
  document.getElementById("post_type").style.marginBottom = "10px";
  document.getElementById("preloader").style.textAlign = "center";
  document.getElementById("preloader").style.marginTop = "100px";



  function generateJSON(date_and_time_stamp, person_name, object, post_id, references) {

      $('#preloader').show();

      return "{\"published\" : \""
                + date_and_time_stamp
                + "\", "
                + "\"actor\" : "
                + "{\"objectType\" : \"PERSON\", \"displayName\" : "
                + "\"" 
                + person_name
                + "\"}, "
                + "\"verb\" : \"said\", \"object\" : " 
                + object
                + ", \"target\" : { \"messageID\" : \"" 
                + post_id
  	      	    + "\", \"taskIDs\" : ["
  	      	    + references
                +  "]}} ";
  }

  function generateTaskObject(name, status, priority) {
    return "{\"objectType\" : \"TASK\" , " 
           + "\"name\" : \"" + name + "\" , "
           + "\"status\" : \"" + status + "\" , "
           + "\"priority\" : \"" + priority + "\"}";
  }

  function generateMessageObject(message) {
    return "{\"objectType\" : \"MESSAGE\" , " 
           + "\"message\" : \"" + message + "\"}";
  }

  function postTypeChange(option) {
  	if (option == "text_post") {
  		var limitedtextfield = document.getElementById("limitedtextfield");
  		limitedtextfield.rows = 5
  		limitedtextfield.cols = 30;
      limitedtextfield.value = "";
      document.getElementById("charCountdown").value = "140";

  	} else {
  		var limitedtextfield = document.getElementById("limitedtextfield");
  		limitedtextfield.rows = 1;
  		limitedtextfield.cols = 30;
      limitedtextfield.value = "";
      document.getElementById("charCountdown").value = "20";
    }

  }

  function setTaskStatus(status) {
    document.getElementById("stream").innerHTML = "";
    document.getElementById("task_status").innerHTML = status;
    $.ajax({
        type: "GET",
        url: "/" + "@groupID" + "/rest/tasks/" + status,
        dataType: "json",
        success: function(data){   
            generateFeed(data);
        }
      });
  }
  
  function refreshFeed() {
      document.getElementById("stream").innerHTML = "";
      if(@toggle==0) {
      	$.ajax({
      	
          type: "GET",
          url: "/" + "@groupID" + "/rest/feed",
          dataType: "json",
          success: function(data){   

              generateFeed(data);
          }});

      	$.ajax({
      	
          type: "GET",
          url: "/" + "@groupID" + "/rest/alltasks",
          dataType: "json",
          success: function(data){   

              addTasks(data);
          }});

      } else if (@toggle==1){
          $.ajax({
          
            type: "GET",
            url: "/" + "@groupID" + "/rest/tasks",
            dataType: "json",
            success: function(data){   
                generateFeed(data);
            }
          });

      } else if (@toggle==2){
      	$.ajax({
      	
          type: "GET",
          url: "/" + "@groupID" + "/rest/git",
          dataType: "json",
          success: function(data){   

              generateFeed(data);
          }
      });
      } else if (@toggle==3){
      	$.ajax({
      	
          type: "GET",
          url: "/" + "@groupID" + "/rest/builds",
          dataType: "json",
          success: function(data){   

              generateFeed(data);
          }
      });
      }
      
  }

  $(document).ready(refreshFeed);	

  function addTasks(task_array) {


  	for (var i=0; i < task_array.length; i++) {

  		var task_id = task_array[i]['id'];
  		task_ids[i] = task_id;


  		var task_name = task_array[i]['object']["name"];
      task_names[i] = task_name;
      tasks[i] = "{ \"value\": \"" + task_name + "\" , \"data\":\"" + task_id + "\" }";
      tasks[i] = jQuery.parseJSON(tasks[i]);

  		var option = document.createElement("option");
  		option.text = task_name;
  		option.style.width = "45%";
  	}

  }

  function autocomplete_setup() {
  $(function ()  {
     var lastHash = -1;
     var hashes = [-1];

     $(":input").autocomplete({
         minLength: 0,
         source: function (request, response) {
            var limitedtextfield = this.element;
	    var dropdown = document.getElementById("post_type");
             if (lastHash>=0 && dropdown.options[dropdown.selectedIndex].value == "text_post") {
                 response($.ui.autocomplete.filter(
                 tasks, request.term.substring(lastHash+1)));          
             }
         },
         focus: function () {
             return false;
         },
         select: function (event, ui) {
             var terms = this.value.split();
             terms.pop();
             terms.push(ui.item.value);
            // terms.push("");
             this.value = this.value.substr(0,lastHash + 1);
             this.value += terms.join("");
             this.value += "#";
             return false;
         },
         messages: {
           noResults: '',
           results: function() {}
         },
        // position: {
          //  of:"#limitedtextfield",
            //offset: "-2px 0 0 0" },
         open: function(event, ui){
            var $input = $(event.target),
            $results = $input.autocomplete("widget");
            $results.css("background-color", "#d9edf7");
            $results.css("list-style", "none");
            $results.css("border", "2px solid");
            $results.css("border-radius", "5px");
            $results.css("width", "50%");
            $results.css("border-color", "#AF3838");
            $results.css("z-index", "30 !important");
            $results.css("position", "absolute");


        }
     }).on("keypress", function (e) {
         var keys = [];
         keys.unshift(e.which);
         if (String.fromCharCode(keys[0]) == "#") {
             lastHash =  $(":focus").val().length;
             hashes.unshift(lastHash);
         }
     }).on("keydown", function (e) {
        if (e.keyCode == 8) {
          var selection = $(":focus").val();
          var deleted_char = selection.charAt(selection.length -1);
          if (deleted_char == "#") {
            hashes.splice(0, 1);
            lastHash = hashes[0];
          $(":focus").autocomplete('close');
          }

        }

     });


   });
}

    /*$(window).scroll(function () {
      if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10) {
        if(@toggle==0) {
          //alert("feed page");
          $.ajax({
            type: "GET",
            url: "/" + "@groupID" + "/rest/morefeed/" + final_post_id,
            dataType: "json",
            success: function(data){   
                addToFeed(data);
            }});
        } else {
          alert("end of page");
        }

      }
  });*/


  function loadMoreFeed() {
    if(@toggle==0) {
          //alert("feed page");
          $.ajax({
            type: "GET",
            url: "/" + "@groupID" + "/rest/morefeed/" + final_post_id,
            dataType: "json",
            success: function(data){   
                addToFeed(data);
            }});
        } else {
          alert("end of page");
        }

  }



  function generateFeed(stream_array) {
    addToFeed(stream_array);
  }

  function addToFeed(stream_array) {

  	//document.getElementById("username").innerHTML="@userName";
    document.getElementById("limitedtextfield").value = "";

  	for (var i=0; i < stream_array.length;i++) {
  		var message_type = stream_array[i][0]['object']["objectType"];
  		var post_no = 0;
  		var post_id = stream_array[i][0]['id'];
  		/*if (i == (stream_array.length - 1)) {
  			final_post_id = post_id; 
  		}*/
      final_post_id = post_id;  

  		var published = stream_array[i][0]['published'];

  		var publisher = stream_array[i][0]['actor']["displayName"];
  		
  		var publisherType = stream_array[i][0]['actor']["objectType"];
  	
  		var verb = stream_array[i][0]['verb'];

  		var post = document.createElement("li");
      post.setAttribute("class", "media");
  		post.id = post_id;
  		post.className = "post";

      var post_body = document.createElement("div");
      post_body.setAttribute("class", "media-body");
  	
  		var stream = document.getElementById("stream");
      //stream.insertBefore(post);
      stream.appendChild(post);
  		/*if (post_count > 0) {
  			stream.insertBefore(post, stream.childNodes[0]);
  		} else {
        stream.insertBefore(post);
  		}*/

  		var date_and_time = document.createElement("small");
  		date_and_time.innerHTML = published + "<br>";

      var reply_message_div = document.createElement("div");
      reply_message_div.setAttribute("class", "col-xs-8");

  		var reply_message = document.createElement("input");
  		reply_message.placeholder = "Your message"
  		reply_message.type = "text";
      reply_message.setAttribute("class", "form-control input-sm");
  					
  		var reply_button = document.createElement("button");
      reply_button.setAttribute("class", "btn btn-default btn-sm");
  		reply_button.innerHTML = 'Reply';
      reply_message_div.appendChild(reply_message);

  		var post_options = document.createElement("div");

  		if (publisher == "@userName") {
  			var delete_button = document.createElement("button");
        delete_button.setAttribute("class", "btn btn-danger btn-xs");
  			delete_button.innerHTML = "Delete";
  			post_options.appendChild(delete_button);

  		 	delete_button.onclick = (function(post_id) {
            	  return function() {
                    var choice = confirm("Are you sure you want to delete this post?");
                    if (choice == true) {
            	         delete_post(post_id);
                   }
              }
         	 }(post_id));
  		}


  		 reply_button.onclick = (function(post_id, reply_message) {
              return function() {
                  replyToPost(post_id, reply_message);
              }
          }(post_id, reply_message));

      var user_image = document.createElement("image");
      user_image.style.width = "8%";
      user_image.style.borderRadius = "50px";
      user_image.style.float = "right";
      user_image.style.margin = "5px";
      user_image.style.marginLeft = "10px";
      user_image.style.border = "3px solid white";

      var email = "user" + String.fromCharCode(64) + "gmail.com";

      if (publisher == "Rob") {

        email = "robert.david.cox" + String.fromCharCode(64) + "gmail.com";

      }

      var default_img = encodeURIComponent("http://assets.eschools.co.uk/images/default_user_300x300.png");

      user_image.src= get_gravatar(email, 250) + "&d=" + default_img;
      post.appendChild(user_image);

  		post_options.style.padding = "10px";
  		
  		switch(message_type){
  		case "MESSAGE":
  			var user = document.createElement("h4");
        user.setAttribute("class", "media-heading");
  			user.innerHTML = publisher;
  		
  			var message_text = stream_array[i][0]['object']["message"];

  			var message = document.createElement("p");
  			message_text = message_text.replace("\n", "<br>");
        message.innerHTML = changeReferencesToLinks(message_text);
  			
  	    post_body.appendChild(user);
  		  post_body.appendChild(message);
        post_body.appendChild(date_and_time);
        post.appendChild(post_body);

        break;
      case "TASK":
  		var task_name = stream_array[i][0]['object']["name"];
        var task_heading = document.createElement("h4");
        task_heading.setAttribute("class", "media-heading");
        task_heading.innerHTML = "Task";
        
  		var task_data = document.createElement("p");

  		var task_status = stream_array[i][0]['object']["status"];
  		var task_priority = stream_array[i][0]['object']["priority"];
  		post.style.backgroundColor = "#d9edf7";
  		task_data.innerHTML = task_name + " BY " + publisher.bold();
  		var task_details = document.createElement("p");
  		task_details.style.cssFloat = "right";
		  task_details.innerHTML = "Status: ".bold() + task_status + "<br> Priority: ".bold() + task_priority;

  		var priority_button = document.createElement("button");
  		priority_button.innerHTML= "Change Task Priority";
  		priority_button.type = "text";
  		priority_button.onclick = (function (post_id) {
  			return function() {
  				var new_priority = window.prompt("Please enter a priority between 1 and 3: ");
  				if (new_priority <  4 && new_priority > 0) {
  					post_new_task_details(new_priority, "p", post_id);
  				} else {
  					alert("Value entered is not between 1 and 3");
  				}
  			}
  		}(post_id));


  		var status_button = document.createElement("button");
  		status_button.innerHTML= "Change Task Status";
  		status_button.type = "text";
  		status_button.onclick = (function (post_id) {
  			return function() {
  				var new_status = window.prompt("Please enter a new task status from (TO_DO/DOING/DONE)");
  				if((new_status == "TO_DO") || (new_status == "DOING") || (new_status == "DONE")) {
  					post_new_task_details(new_status, "s", post_id);
  				} else {
  					alert("Not a valid status");
  				}
  			
  			}
		  }(post_id));


    		post_options.appendChild(priority_button);
    		post_options.appendChild(status_button);

    		if (publisher == "@userName") {
    			var assign_button = document.createElement("button");
    			assign_button.innerHTML = "Assign members";
    			post_options.appendChild(assign_button);

    			assign_button.onclick = (function(post_id) {
    				  return function() {
    					// delete_post(post_id);
    			 }
    			}(post_id));
    		}

        post_body.appendChild(task_heading);
        post_body.appendChild(task_details);
  			post_body.appendChild(task_data);	
        post_body.appendChild(date_and_time);	
        post.appendChild(post_body);
  			//post.appendChild(post_options);
			break;
  		case "JENKINS" :
  			var jenkins = document.createElement("h4");
        jenkins.setAttribute("class", "media-heading");
  			jenkins.innerHTML = publisher;

        user_image.src = "@routes.Assets.at("images/jenkins.png")";
        user_image.style.width = "7%";
        user_image.style.border = "";
  			
  			var build_data = document.createElement("p");
  			var build_name = stream_array[i][0]['object']["name"];
  			var build_number = stream_array[i][0]['object']["number"];
  			var build_status = stream_array[i][0]['object']["status"];
  			var build_url = stream_array[i][0]['object']["url"];
  			
  			var build_link = document.createElement('a');
  			build_link.href = build_url;
  			build_link.innerHTML = "See build";
  			
  			if (build_status == "SUCCESS") {
  				post.style.backgroundColor = "#AFD772";	
          //post_body.setAttribute("class", "alert alert-success");
  			} else {
  				post.style.backgroundColor = "#FF7A70";	
          //post_body.setAttribute("class", "alert alert-danger");
  			}
  			
  			build_data.innerHTML = build_name + " build " + build_number + " finished with status: " + build_status + ". ";
			  build_data.appendChild(build_link);
  			
  			post_body.appendChild(jenkins);
  			post_body.appendChild(build_data);
        post_body.appendChild(date_and_time);
        post.appendChild(post_body);
  			break;
  		case "GIT":
  			var repo = stream_array[i][0]['object']['repository'];
  			var repo_name = repo["name"];
  			var repo_url = repo["url"];
  			var branch = stream_array[i][0]['object']['branch'];
  			var branch_name = branch["name"];
  			var branch_url = branch["url"];

        user_image.src = "@routes.Assets.at("images/git.png")";
        user_image.style.width = "7%";
        user_image.style.border = "";

        var git_heading = document.createElement("h4");
        git_heading.setAttribute("class", "media-heading");
        git_heading.innerHTML = "GIT";
  			
  			var branch_link = document.createElement('a');
  			branch_link.href = branch_url;
  			branch_link.innerHTML = branch_name.bold()
  			
  			var repo_link = document.createElement('a');
  			repo_link.href = repo_url;
  			repo_link.innerHTML = repo_name.bold()
  			
  			
  			var git_data = document.createElement("div");
  			git_data.innerHTML = publisher.bold() + " pushed to branch " + $(branch_link).outerHTML() + " at repository " + $(repo_link).outerHTML();
  			
  			var commits = stream_array[i][0]['object']['commits'];
  			var commit_total = stream_array[i][0]['object']['totalCommits'];
  			var commit_data = document.createElement("div");
  			var commit_list = document.createElement("ul");
  			commit_data.appendChild(commit_list);
  			for(var k = 0; k < Math.min(2,commit_total); k++) {
  				var commit = commits[k];
  				var commit_url = commit["url"];
  				var commit_author = commit["author"];
  				var commit_message = commit["message"];
  				var commit_link = document.createElement('a');
  				commit_link.href = commit_url;
  				commit_link.innerHTML = "See commit"
  				
  				
  				var commit_list_entry = document.createElement("li");
  				commit_list_entry.style.display="block";
  				commit_list_entry.innerHTML = commit_author.bold() + ": " + commit_message + " " + $(commit_link).outerHTML();
  				commit_list.appendChild(commit_list_entry);
  				
  			}
  			if (commit_total > 2){
  				var summary_link = document.createElement('a');
  				summary_link.href = branch_url;
  				summary_link.innerHTML = "... and " + (commit_total - 2) + " more commits";
  				var commit_summary = document.createElement("li");
  				commit_summary.appendChild(summary_link);
  				commit_summary.style.display="block";
  				commit_list.appendChild(commit_summary);
  				
  			}
  			
  			post.style.backgroundColor = "#fcf8e3";
        //post_body.setAttribute("class", "alert, alert-info");
  			
        post_body.appendChild(git_heading);
  			post_body.appendChild(git_data);
  			post_body.appendChild(commit_data);
        post_body.appendChild(date_and_time);
  			post.appendChild(post_body);
  			break;
  		}

  		 reply_button.onclick = (function(post_id, reply_message) {
              return function() {
                  replyToPost(post_id, reply_message);
              }
          }(post_id, reply_message));

  		 reply_message.onkeypress = (function(post_id, reply_message) { 
  		 	return function() {
  		 			if (event.keyCode == 13) {
  		 				replyToPost(post_id, reply_message);
  		 			}
  		 	}
  		 }(post_id, reply_message));

  		var j = 1;
  		while (j < stream_array[i].length) {

  			if (stream_array[i][j]['object']["objectType"] == "TASK") {
  				var task_reference_div = document.createElement("div");
  				task_reference_div.innerHTML = "Referencing: " + stream_array[i][j]['object']["name"];
  				task_reference_div.className = "post";
  				task_reference_div.style["cssFloat"] = "right";
  				task_reference_div.style["background"] = "#d9edf7";
  				task_reference_div.style["width"] = "30%";

  				//post.insertBefore(task_reference_div, post.firstChild);
  				j++;

  			} else {
  				var reply_div = document.createElement("div");
  				//reply_div.className = "reply_post";
  				reply_div.setAttribute("class", "media");
      	  reply_div.style.paddingLeft = "10%";

          var user_image = document.createElement("image");
          user_image.style.width = "6%";
          user_image.style.borderRadius = "50px";
          user_image.style.float = "left";
          user_image.style.marginRight = "10px";
          user_image.style.marginTop = "10px";
          user_image.style.border = "2px solid white";

          reply_div.appendChild(user_image);

          var reply_div_body = document.createElement("div");
          reply_div_body.setAttribute("class", "media-body");
  				
  				var reply_published = document.createElement("small");
  				reply_published.innerHTML = stream_array[i][j]['published'];

  				var reply_publisher = document.createElement("h4");
          reply_publisher.setAttribute("class", "media-heading");
  				reply_publisher.innerHTML = stream_array[i][j]['actor']["displayName"];

          var email = "user" + String.fromCharCode(64) + "gmail.com";

          if (reply_publisher.innerHTML == "Rob") {

            email = "robert.david.cox" + String.fromCharCode(64) + "gmail.com";

          }

          var default_img = encodeURIComponent("http://assets.eschools.co.uk/images/default_user_300x300.png");

          user_image.src= get_gravatar(email, 250) + "&d=" + default_img;

  				var reply_message_text = document.createElement("p");
  				reply_message_text.innerHTML = changeReferencesToLinks(stream_array[i][j]['object']["message"]);
  			
  				var reply_publisherType = stream_array[i][j]['actor']["objectType"];
  	
  				var reply_verb = stream_array[i][j]['verb'];
  		
  				var reply_message_type = stream_array[i][j]['object']["objectType"];

          post_body.appendChild(reply_div);
          reply_div.appendChild(reply_div_body);
          reply_div_body.appendChild(reply_publisher);
          reply_div_body.appendChild(reply_published);
          reply_div_body.appendChild(reply_message_text);    
  			j++;
  		}


  		}

      post_body.appendChild(reply_message_div);
      post_body.appendChild(reply_button);
  	  post.appendChild(post_options);

  		post_no = post_no + 1;
  	}

    autocomplete_setup();
    $('#preloader').hide();
  	
  }

  function get_gravatar(email, size) {


    var MD5=function(s){function L(k,d){return(k<<d)|(k>>>(32-d))}function K(G,k){var I,d,F,H,x;F=(G&2147483648);H=(k&2147483648);I=(G&1073741824);d=(k&1073741824);x=(G&1073741823)+(k&1073741823);if(I&d){return(x^2147483648^F^H)}if(I|d){if(x&1073741824){return(x^3221225472^F^H)}else{return(x^1073741824^F^H)}}else{return(x^F^H)}}function r(d,F,k){return(d&F)|((~d)&k)}function q(d,F,k){return(d&k)|(F&(~k))}function p(d,F,k){return(d^F^k)}function n(d,F,k){return(F^(d|(~k)))}function u(G,F,aa,Z,k,H,I){G=K(G,K(K(r(F,aa,Z),k),I));return K(L(G,H),F)}function f(G,F,aa,Z,k,H,I){G=K(G,K(K(q(F,aa,Z),k),I));return K(L(G,H),F)}function D(G,F,aa,Z,k,H,I){G=K(G,K(K(p(F,aa,Z),k),I));return K(L(G,H),F)}function t(G,F,aa,Z,k,H,I){G=K(G,K(K(n(F,aa,Z),k),I));return K(L(G,H),F)}function e(G){var Z;var F=G.length;var x=F+8;var k=(x-(x%64))/64;var I=(k+1)*16;var aa=Array(I-1);var d=0;var H=0;while(H<F){Z=(H-(H%4))/4;d=(H%4)*8;aa[Z]=(aa[Z]|(G.charCodeAt(H)<<d));H++}Z=(H-(H%4))/4;d=(H%4)*8;aa[Z]=aa[Z]|(128<<d);aa[I-2]=F<<3;aa[I-1]=F>>>29;return aa}function B(x){var k="",F="",G,d;for(d=0;d<=3;d++){G=(x>>>(d*8))&255;F="0"+G.toString(16);k=k+F.substr(F.length-2,2)}return k}function J(k){k=k.replace(/rn/g,"n");var d="";for(var F=0;F<k.length;F++){var x=k.charCodeAt(F);if(x<128){d+=String.fromCharCode(x)}else{if((x>127)&&(x<2048)){d+=String.fromCharCode((x>>6)|192);d+=String.fromCharCode((x&63)|128)}else{d+=String.fromCharCode((x>>12)|224);d+=String.fromCharCode(((x>>6)&63)|128);d+=String.fromCharCode((x&63)|128)}}}return d}var C=Array();var P,h,E,v,g,Y,X,W,V;var S=7,Q=12,N=17,M=22;var A=5,z=9,y=14,w=20;var o=4,m=11,l=16,j=23;var U=6,T=10,R=15,O=21;s=J(s);C=e(s);Y=1732584193;X=4023233417;W=2562383102;V=271733878;for(P=0;P<C.length;P+=16){h=Y;E=X;v=W;g=V;Y=u(Y,X,W,V,C[P+0],S,3614090360);V=u(V,Y,X,W,C[P+1],Q,3905402710);W=u(W,V,Y,X,C[P+2],N,606105819);X=u(X,W,V,Y,C[P+3],M,3250441966);Y=u(Y,X,W,V,C[P+4],S,4118548399);V=u(V,Y,X,W,C[P+5],Q,1200080426);W=u(W,V,Y,X,C[P+6],N,2821735955);X=u(X,W,V,Y,C[P+7],M,4249261313);Y=u(Y,X,W,V,C[P+8],S,1770035416);V=u(V,Y,X,W,C[P+9],Q,2336552879);W=u(W,V,Y,X,C[P+10],N,4294925233);X=u(X,W,V,Y,C[P+11],M,2304563134);Y=u(Y,X,W,V,C[P+12],S,1804603682);V=u(V,Y,X,W,C[P+13],Q,4254626195);W=u(W,V,Y,X,C[P+14],N,2792965006);X=u(X,W,V,Y,C[P+15],M,1236535329);Y=f(Y,X,W,V,C[P+1],A,4129170786);V=f(V,Y,X,W,C[P+6],z,3225465664);W=f(W,V,Y,X,C[P+11],y,643717713);X=f(X,W,V,Y,C[P+0],w,3921069994);Y=f(Y,X,W,V,C[P+5],A,3593408605);V=f(V,Y,X,W,C[P+10],z,38016083);W=f(W,V,Y,X,C[P+15],y,3634488961);X=f(X,W,V,Y,C[P+4],w,3889429448);Y=f(Y,X,W,V,C[P+9],A,568446438);V=f(V,Y,X,W,C[P+14],z,3275163606);W=f(W,V,Y,X,C[P+3],y,4107603335);X=f(X,W,V,Y,C[P+8],w,1163531501);Y=f(Y,X,W,V,C[P+13],A,2850285829);V=f(V,Y,X,W,C[P+2],z,4243563512);W=f(W,V,Y,X,C[P+7],y,1735328473);X=f(X,W,V,Y,C[P+12],w,2368359562);Y=D(Y,X,W,V,C[P+5],o,4294588738);V=D(V,Y,X,W,C[P+8],m,2272392833);W=D(W,V,Y,X,C[P+11],l,1839030562);X=D(X,W,V,Y,C[P+14],j,4259657740);Y=D(Y,X,W,V,C[P+1],o,2763975236);V=D(V,Y,X,W,C[P+4],m,1272893353);W=D(W,V,Y,X,C[P+7],l,4139469664);X=D(X,W,V,Y,C[P+10],j,3200236656);Y=D(Y,X,W,V,C[P+13],o,681279174);V=D(V,Y,X,W,C[P+0],m,3936430074);W=D(W,V,Y,X,C[P+3],l,3572445317);X=D(X,W,V,Y,C[P+6],j,76029189);Y=D(Y,X,W,V,C[P+9],o,3654602809);V=D(V,Y,X,W,C[P+12],m,3873151461);W=D(W,V,Y,X,C[P+15],l,530742520);X=D(X,W,V,Y,C[P+2],j,3299628645);Y=t(Y,X,W,V,C[P+0],U,4096336452);V=t(V,Y,X,W,C[P+7],T,1126891415);W=t(W,V,Y,X,C[P+14],R,2878612391);X=t(X,W,V,Y,C[P+5],O,4237533241);Y=t(Y,X,W,V,C[P+12],U,1700485571);V=t(V,Y,X,W,C[P+3],T,2399980690);W=t(W,V,Y,X,C[P+10],R,4293915773);X=t(X,W,V,Y,C[P+1],O,2240044497);Y=t(Y,X,W,V,C[P+8],U,1873313359);V=t(V,Y,X,W,C[P+15],T,4264355552);W=t(W,V,Y,X,C[P+6],R,2734768916);X=t(X,W,V,Y,C[P+13],O,1309151649);Y=t(Y,X,W,V,C[P+4],U,4149444226);V=t(V,Y,X,W,C[P+11],T,3174756917);W=t(W,V,Y,X,C[P+2],R,718787259);X=t(X,W,V,Y,C[P+9],O,3951481745);Y=K(Y,h);X=K(X,E);W=K(W,v);V=K(V,g)}var i=B(Y)+B(X)+B(W)+B(V);return i.toLowerCase()};

    var size = size || 80;
    return 'http://www.gravatar.com/avatar/' + MD5(email.trim().toLowerCase()) + '.jpg?s=' + size;

  }


  function post_new_task_details(value, id, post_id) {

  	var json = "{\"id\" : \"" + post_id + "\", "

  	if (id == "p") {

  		json += "\"priority\": " + value;

  	}

  	if (id == "s") {

  		json += "\"status\": \"" + value + "\"";

  	}

  	json += "}";


   	$.ajax({
		type: "POST",
		url: "/" + "@groupID" + "/rest/update/task",
		dataType: "json",
		data: {"activity":json},
		complete: refreshFeed
	});      

  }

  function delete_post(post_id) {

  	var json = "{\"id\" : \"" + post_id + "\"}"

  	$.ajax({
		type: "POST",
		url: "/" + "@groupID" + "/rest/delete/post",
		dataType: "json",
		data: {"activity":json},
		complete: refreshFeed
	});    


  }

  function getTimeStamp() {
    var currentdate = new Date();
    return ("" + currentdate.getDate() + "/"
                    + (currentdate.getMonth()+1)  + "/" 
                    + currentdate.getFullYear() + " at "
                    +  getLeadingZeros(currentdate.getHours()) + ":"  
                    + getLeadingZeros(currentdate.getMinutes()) + ":" 
                    + getLeadingZeros(currentdate.getSeconds())); 
  }

  function getLeadingZeros(number) {
  	var numberString = number + "";
  	if (numberString.length < 2) {
  		return "0" + numberString;
  	} else {
  		return number;
  	}
  }

  function replyToPost(post_id, reply_message) {

  	var post = document.getElementById(post_id);
  	var reply_name_text = "@userName";
  	var reply_message_text = reply_message.value;

  	if (reply_message_text == "" && reply_message_text != null) {
  		alert("Reply cannot be empty.");
  	} else {

  		var date_and_time_stamp = getTimeStamp();
  		var references = [];

      var reference = extractReferences(reply_message_text);
        var ref_id = getRefId(reference);

        var references = [];

        if (ref_id != "") {

          references =  ["\"" + ref_id + "\""];

        }


  /*	var reply = generateJSON(date_and_time_stamp, reply_name_text, "MESSAGE",
  							 reply_message_text, post_id, references); */

      var reply = "{\"published\" : \""
                + date_and_time_stamp
                + "\", "
                + "\"actor\" : "
                + "{\"objectType\" : \"PERSON\", \"displayName\" : "
                + "\"" 
                + reply_name_text
                + "\"}, "
                + "\"verb\" : \"said\", \"object\" : {\"objectType\""
                + " : \"MESSAGE\", \"message\" : " 
                + "\"" 
                + reply_message_text
                + "\"}, \"target\" : { \"messageID\" : \"" 
                + post_id
  	      + "\", \"taskIDs\" : ["
  	      + references
                +  "]}} "; 

      $.ajax({
      	type: "POST",
      	url: "/" + "@groupID" + "/rest/message",
      	dataType: "json",
      	data: {"activity":reply},
      	complete: refreshFeed 
      });

  	}

  }

  function changeReferencesToLinks(message) {


    var hashtagRegex = new RegExp("#[^#]*#");
    var tag = hashtagRegex.exec(message);

    var linked_tag = document.createElement('a');
    linked_tag.href = "http://www.google.com";
    linked_tag.innerHTML = tag;

    return message.replace(tag, $(linked_tag).outerHTML());

  }

  function extractReferences(message) {

      var result = message.split("#");

      var i = 0;
      
      while (i < task_ids.length) {
          if (task_names[i] == result[1]) {
            return result[1];
          }
          i++;
      }
      return "";
  }

  function getRefId(reference) {

    var i = 0;
      while (i < task_ids.length) {
          if (task_names[i] == reference) {
            return task_ids[i];
          }
          i++;
      }
      return "";

  }

  function postToFeed() {

      var currentdate = new Date();
      
      var name_text = "@userName";

      var message_text = document.getElementById("limitedtextfield").value;
      
      message_text = message_text.replace("\n", "\\n").replace("\t", "\\t").replace("\r", "\\r");
      
      var dropdown = document.getElementById("post_type");
      var dropdown_value = dropdown.options[dropdown.selectedIndex].value;
      
      var date_and_time_stamp = getTimeStamp();
      
      if (name_text != "" && message_text != "" && dropdown_value == "text_post") {

        var reference = extractReferences(message_text);
        var ref_id = getRefId(reference);

  	    var references = [];

        if (ref_id != "") {

      		references =  ["\"" + ref_id + "\""];

        }

      //  message_text = message_text.replace("#".concat(reference).concat(, "");

      	

      var message_object = generateMessageObject(message_text)    

      var post = generateJSON(date_and_time_stamp, name_text, message_object,
      						"", references);

        $.ajax({
            type: "POST",
            url: "/" + "@groupID" + "/rest/message",
            dataType: "json",
            data: {"activity":post},
  	        complete: refreshFeed                
        });
                    
        //document.getElementById("name").value = "";
        document.getElementById("limitedtextfield").value = ""; 


          
      } else if (name_text != "" && message_text != "" && dropdown_value == "task") {
          

          var references = [];

          var task_object = generateTaskObject(message_text, "TO_DO", "1")
          var post = generateJSON(date_and_time_stamp, name_text, task_object, "", references);

         $.ajax({
            type: "POST",
            url: "/" + "@groupID" + "/rest/message",
            dataType: "json",
            data: {"activity":post},
            complete: refreshFeed
        });      
                    


          
      } 
      document.getElementById("limitedtextfield").value = "";
      document.getElementById("charCountdown").value = "140";
  }

  </script>
      <!-- Bootstrap core JavaScript
      ================================================== -->
      <!-- Placed at the end of the document so the pages load faster -->
      <script src="@routes.Assets.at("javascripts/bootstrap.min.js")"></script>
  </body>
</html>

